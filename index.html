<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>لوحة تحكم المدير</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Firebase v11 Modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { 
    getAuth, signInAnonymously, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import { 
    getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, onSnapshot, addDoc, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  /***** 1) إعداد Firebase — استبدل بهذه الإعدادات الخاصة بك *****/
  const firebaseConfig = {
    apiKey: "AIzaSyBGFMZtSytIPzF4XYLyA34DpF5q_k-UPL8",
    authDomain: "fir-dba4c.firebaseapp.com",
    projectId: "fir-dba4c",
    storageBucket: "fir-dba4c.firebasestorage.app",
    messagingSenderId: "160255207915",
    appId: "1:160255207915:web:ce8e69d43f62daf476d1ae",
    measurementId: "G-GYPNMR85G2"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /***** 2) عناصر الواجهة *****/
  const loginView   = document.getElementById("loginView");
  const panelView   = document.getElementById("panelView");
  const whoSpan     = document.getElementById("whoami");
  const usersBody   = document.getElementById("usersBody");
  const searchBox   = document.getElementById("searchBox");
  const genHashBtn  = document.getElementById("genHashBtn");
  const hashOut     = document.getElementById("hashOut");

  const lgUser = document.getElementById("lgUser");
  const lgPass = document.getElementById("lgPass");
  const lgBtn  = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  // نافذة تفاصيل المستخدم
  const modal = document.getElementById("userModal");
  const closeModalBtn = document.getElementById("closeModal");
  const mName = document.getElementById("mName");
  const mEmail = document.getElementById("mEmail");
  const mTg = document.getElementById("mTg");
  const mIP = document.getElementById("mIP");
  const mBalance = document.getElementById("mBalance");
  const mBotStatus = document.getElementById("mBotStatus");
  const mSubEnd = document.getElementById("mSubEnd");
  const mGroupsCount = document.getElementById("mGroupsCount");
  const mGroupsList = document.getElementById("mGroupsList");
  const mUptime = document.getElementById("mUptime");
  const addBalInput = document.getElementById("addBalInput");
  const addBalBtn = document.getElementById("addBalBtn");
  const toggleBotBtn = document.getElementById("toggleBotBtn");
  const extend30Btn = document.getElementById("extend30Btn");
  const saveGroupsBtn = document.getElementById("saveGroupsBtn");
  const groupsTextarea = document.getElementById("groupsTextarea");

  let currentAdmin = null;     // بيانات الأدمن بعد تسجيل الدخول (من Firestore)
  let currentUserDocId = null; // المستخدم المفتوح في المودال

  /***** 3) أدوات مساعدة *****/
  async function sha256(text) {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function show(view) {
    loginView.style.display = (view === "login" ? "block" : "none");
    panelView.style.display = (view === "panel" ? "block" : "none");
  }

  function fmtMoney(n) {
    return (Number(n || 0)).toFixed(2);
  }

  function parseGroups(str) {
    return str.split("\n").map(s=>s.trim()).filter(Boolean);
  }

  /***** 4) تسجيل مجهول لفتح صلاحيات القراءة (حسب القواعد) *****/
  onAuthStateChanged(auth, async (fbUser) => {
    if (!fbUser) {
      await signInAnonymously(auth);
      return;
    }
    // لو الأدمن مسجّل مسبقًا في localStorage، افتح اللوحة
    const cached = localStorage.getItem("adminDoc");
    if (cached) {
      currentAdmin = JSON.parse(cached);
      whoSpan.textContent = currentAdmin.displayName || currentAdmin.username || "مدير";
      show("panel");
      startUsersListener();
    } else {
      show("login");
    }
  });

  /***** 5) تسجيل دخول الأدمن (username + passwordHash في Firestore) *****/
  lgBtn.addEventListener("click", async () => {
    const u = lgUser.value.trim();
    const p = lgPass.value;
    if (!u || !p) return alert("أدخل اسم المستخدم وكلمة المرور");
    const hash = await sha256(p);

    // ابحث عن الأدمن
    const q = query(collection(db, "admins"), where("username", "==", u), where("passwordHash", "==", hash));
    const snap = await getDocs(q);
    if (snap.empty) {
      alert("بيانات الدخول غير صحيحة");
      return;
    }
    const docRef = snap.docs[0];
    currentAdmin = { id: docRef.id, ...docRef.data() };
    localStorage.setItem("adminDoc", JSON.stringify(currentAdmin));
    whoSpan.textContent = currentAdmin.displayName || currentAdmin.username || "مدير";
    show("panel");
    startUsersListener();
  });

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("adminDoc");
    currentAdmin = null;
    show("login");
  });

  // مولّد هاش (يساعدك تضيف أدمن جديد في Firestore)
  genHashBtn.addEventListener("click", async () => {
    const p = prompt("اكتب كلمة المرور التي تريد تحويلها إلى SHA-256:");
    if (!p) return;
    hashOut.value = await sha256(p);
    hashOut.select();
    document.execCommand("copy");
    alert("تم نسخ الهاش. أضفه في admins.passwordHash");
  });

  /***** 6) تحميل المستخدمين + بحث *****/
  let unsubUsers = null;
  function startUsersListener() {
    if (unsubUsers) { unsubUsers(); unsubUsers = null; }
    unsubUsers = onSnapshot(collection(db, "users"), (snapshot) => {
      usersBody.innerHTML = "";
      snapshot.forEach(docSnap => {
        const u = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.name || "-"}</td>
          <td>${u.email || "-"}</td>
          <td>${u.telegram_id || "-"}</td>
          <td>${fmtMoney(u.balance)}</td>
          <td>${u.botActive ? "✅ مفعل" : "❌ متوقف"}</td>
          <td>
            <button class="btn" data-id="${docSnap.id}">فتح البوت</button>
          </td>
        `;
        usersBody.appendChild(tr);
      });
    });

    // فتح تفاصيل المستخدم
    usersBody.addEventListener("click", async (e) => {
      if (e.target.tagName === "BUTTON" && e.target.dataset.id) {
        openUserModal(e.target.dataset.id);
      }
    });

    // بحث بسيط داخل الجدول
    searchBox.addEventListener("keyup", () => {
      const f = searchBox.value.trim().toLowerCase();
      const rows = usersBody.querySelectorAll("tr");
      rows.forEach(r => {
        const t = r.innerText.toLowerCase();
        r.style.display = t.includes(f) ? "" : "none";
      });
    });
  }

  /***** 7) نافذة تفاصيل المستخدم + إجراءات *****/
  async function openUserModal(userId) {
    currentUserDocId = userId;
    const ref = doc(db, "users", userId);
    const s = await getDoc(ref);
    if (!s.exists()) return alert("المستخدم غير موجود");
    const u = s.data();

    mName.textContent = u.name || "-";
    mEmail.textContent = u.email || "-";
    mTg.textContent = u.telegram_id || "-";
    mIP.textContent = u.ip || "-";
    mBalance.textContent = fmtMoney(u.balance);
    mBotStatus.textContent = u.botActive ? "✅ شغال" : "❌ متوقف";

    const sub = u.subscription || {};
    mSubEnd.textContent = sub.end || "-";

    const groups = (sub.groups || []);
    mGroupsCount.textContent = groups.length;
    mGroupsList.innerHTML = groups.length ? groups.map(g=>`<li>${g}</li>`).join("") : "<li>لا يوجد</li>";
    groupsTextarea.value = groups.join("\n");

    // عدّاد تشغيل (تقريبي): إن لم تكن تحفظ startAt؛ نستخدم createdAt كبداية
    const startISO = u.startAt || u.createdAt;
    if (startISO) {
      updateUptime(startISO);
      if (window.__uptimer) clearInterval(window.__uptimer);
      window.__uptimer = setInterval(()=>updateUptime(startISO), 1000);
    } else {
      mUptime.textContent = "-";
    }

    modal.style.display = "block";
  }

  function updateUptime(iso) {
    const start = new Date(iso);
    const now = new Date();
    const diff = Math.max(0, now - start);
    const s = Math.floor(diff/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    mUptime.textContent = `${h}س ${m}د ${sec}ث`;
  }

  closeModalBtn.addEventListener("click", () => {
    modal.style.display = "none";
    if (window.__uptimer) clearInterval(window.__uptimer);
  });

  // إضافة رصيد
  addBalBtn.addEventListener("click", async () => {
    if (!currentUserDocId) return;
    const v = parseFloat(addBalInput.value);
    if (isNaN(v)) return alert("اكتب مبلغ صحيح");
    const ref = doc(db, "users", currentUserDocId);
    const s = await getDoc(ref);
    const u = s.data();
    const nb = (u.balance || 0) + v;
    await updateDoc(ref, { balance: nb });
    await logAudit({ action:"add_balance", amount:v, target: currentUserDocId });
    mBalance.textContent = fmtMoney(nb);
    addBalInput.value = "";
    alert("تم تحديث الرصيد");
  });

  // تفعيل/إيقاف البوت
  toggleBotBtn.addEventListener("click", async () => {
    if (!currentUserDocId) return;
    const ref = doc(db, "users", currentUserDocId);
    const s = await getDoc(ref);
    const u = s.data();
    const newState = !(u.botActive);
    await updateDoc(ref, { botActive: newState });
    await logAudit({ action:"toggle_bot", botActive:newState, target: currentUserDocId });
    mBotStatus.textContent = newState ? "✅ شغال" : "❌ متوقف";
  });

  // تمديد 30 يوم
  extend30Btn.addEventListener("click", async () => {
    if (!currentUserDocId) return;
    const ref = doc(db, "users", currentUserDocId);
    const s = await getDoc(ref);
    const u = s.data();
    const sub = u.subscription || {};
    const base = sub.end ? new Date(sub.end) : new Date();
    base.setMonth(base.getMonth() + 1);
    const newEnd = base.toISOString().split("T")[0];
    await updateDoc(ref, { subscription: { ...(sub || {}), active: true, end: newEnd, groups: sub.groups || [] } });
    await logAudit({ action:"extend_subscription", days:30, target: currentUserDocId });
    mSubEnd.textContent = newEnd;
    alert("تم التمديد 30 يوم");
  });

  // حفظ المجموعات
  saveGroupsBtn.addEventListener("click", async () => {
    if (!currentUserDocId) return;
    const ref = doc(db, "users", currentUserDocId);
    const s = await getDoc(ref);
    const u = s.data();
    const sub = u.subscription || {};
    const groups = parseGroups(groupsTextarea.value);
    if (groups.length > 3) return alert("مسموح بحد أقصى 3 مجموعات");
    await updateDoc(ref, { subscription: { ...(sub || {}), groups, active: sub.active ?? true, end: sub.end || null } });
    await logAudit({ action:"save_groups", groups, target: currentUserDocId });
    mGroupsCount.textContent = groups.length;
    mGroupsList.innerHTML = groups.length ? groups.map(g=>`<li>${g}</li>`).join("") : "<li>لا يوجد</li>";
    alert("تم حفظ المجموعات");
  });

  /***** 8) سجل التدقيق (Audit Log) *****/
  async function logAudit(obj) {
    try {
      await addDoc(collection(db, "audit"), {
        ...obj,
        adminId: currentAdmin?.id || null,
        adminName: currentAdmin?.displayName || currentAdmin?.username || null,
        at: serverTimestamp()
      });
    } catch(e) {
      console.warn("audit log failed", e);
    }
  }
</script>
<style>
  body{font-family:Tajawal,Arial; background:#f5f7fb; margin:0; padding:20px;}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin:0 auto;max-width:1100px;}
  h2{margin:4px 0 16px;}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,textarea,button{font:inherit}
  input,textarea{border:1px solid #ddd;border-radius:10px;padding:10px}
  button.btn{background:#0070ba;color:#fff;border:none;border-radius:10px;padding:8px 14px;cursor:pointer}
  button.btn:hover{opacity:.9}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border-bottom:1px solid #eee;padding:10px;text-align:center}
  th{background:#0d6efd;color:#fff}
  /* Views */
  #loginView{display:none}
  #panelView{display:none}
  .badge{display:inline-block;padding:3px 8px;border-radius:9px;background:#eef;color:#333}
  /* Modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);justify-content:center;align-items:flex-start;padding-top:40px;z-index:50}
  .modal .box{background:#fff;border-radius:14px;max-width:720px;width:96%;padding:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .muted{color:#666}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .danger{background:#dc3545}
  .ok{background:#28a745}
  .warn{background:#f59e0b}
</style>
</head>
<body>

  <!-- شاشة تسجيل دخول الأدمن -->
  <div id="loginView" class="card">
    <h2>🔐 تسجيل دخول الأدمن</h2>
    <div class="row">
      <label>اسم المستخدم:</label>
      <input id="lgUser" placeholder="username" />
      <label>كلمة المرور:</label>
      <input id="lgPass" type="password" placeholder="••••••••" />
      <button id="loginBtn" class="btn">دخول</button>
    </div>

    <hr>
    <div class="row">
      <button id="genHashBtn" class="btn warn">توليد SHA-256 لكلمة مرور</button>
      <input id="hashOut" readonly style="flex:1" placeholder="يظهر هنا الهاش لتضعه بــ admins.passwordHash" />
    </div>
    <p class="muted">ملاحظة: يتم تخزين كلمات المرور في Firestore بشكل <b>هاش</b> فقط. لا تخزنها كنص صريح.</p>
  </div>

  <!-- لوحة التحكم -->
  <div id="panelView" class="card">
    <div class="row" style="justify-content:space-between">
      <h2>📊 لوحة تحكم المدير</h2>
      <div>
        <span class="badge">مرحبًا، <b id="whoami">مدير</b></span>
        <button id="logoutBtn" class="btn danger" style="margin-inline-start:10px">تسجيل خروج</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="searchBox" style="flex:1" placeholder="ابحث باسم/إيميل/تليجرام..." />
    </div>

    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>الإيميل</th>
          <th>تليجرام</th>
          <th>الرصيد</th>
          <th>حالة البوت</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>

  <!-- نافذة تفاصيل المستخدم -->
  <div id="userModal" class="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between">
        <h3>👤 تفاصيل المستخدم</h3>
        <button id="closeModal" class="btn danger">إغلاق</button>
      </div>
      <div class="grid2">
        <div>
          <p><b>الاسم:</b> <span id="mName">-</span></p>
          <p><b>الإيميل:</b> <span id="mEmail">-</span></p>
          <p><b>تليجرام:</b> <span id="mTg">-</span></p>
          <p><b>IP:</b> <span id="mIP">-</span></p>
        </div>
        <div>
          <p><b>الرصيد:</b> <span id="mBalance">0.00</span> $</p>
          <p><b>حالة البوت:</b> <span id="mBotStatus">-</span></p>
          <p><b>انتهاء الاشتراك:</b> <span id="mSubEnd">-</span></p>
          <p><b>مدة التشغيل:</b> <span id="mUptime">-</span></p>
        </div>
      </div>

      <hr>
      <h4>📦 المجموعات المفعلة (<span id="mGroupsCount">0</span>)</h4>
      <ul id="mGroupsList" class="muted" style="min-height:24px"></ul>

      <h4>تعديل المجموعات (بحد أقصى 3)</h4>
      <textarea id="groupsTextarea" rows="4" placeholder="-100111
-100222
-100333"></textarea>
      <div class="tools">
        <button id="saveGroupsBtn" class="btn ok">حفظ المجموعات</button>
      </div>

      <hr>
      <h4>💳 الأرصدة والاشتراكات</h4>
      <div class="tools">
        <input id="addBalInput" type="number" step="0.01" placeholder="+ مبلغ" />
        <button id="addBalBtn" class="btn">إضافة رصيد</button>
        <button id="extend30Btn" class="btn warn">تمديد 30 يوم</button>
        <button id="toggleBotBtn" class="btn danger">تفعيل/إيقاف البوت</button>
      </div>
    </div>
  </div>

</body>
</html>
